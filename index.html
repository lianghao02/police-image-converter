<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­¦å‹™å°ˆç”¨ï¼šåœ–ç‰‡è½‰æª”åŠ©æ‰‹ v3.0 (é€šç”¨ç‰ˆ)</title>
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding-top: 30px; color: #333; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); width: 700px; text-align: center; }
        .upload-area { border: 3px dashed #bdc3c7; border-radius: 10px; padding: 40px; cursor: pointer; background-color: #f9f9f9; margin-bottom: 20px;}
        .upload-area:hover { border-color: #3498db; }
        .btn { color: white; border: none; padding: 15px 40px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1em; font-weight: bold; background-color: #2980b9; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;}
        .btn:hover { background-color: #21618c; transform: translateY(-2px); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }
        
        .settings-area { margin-bottom: 20px; padding: 15px; background-color: #ecf0f1; border-radius: 8px; text-align: left; display: flex; align-items: center; gap: 15px;}
        .settings-area select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; flex: 1; }
        
        #fileInput { display: none; }
        .file-list { text-align: left; margin-bottom: 15px; max-height: 120px; overflow-y: auto; display: none; padding: 10px; border: 1px solid #eee; border-radius: 5px;}
        .progress-bar { width: 100%; background: #ecf0f1; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 20px; display: none;}
        .progress-fill { height: 100%; width: 0%; background: #27ae60; transition: width 0.3s; }
        #statusText { margin-top: 8px; font-size: 0.9em; font-weight: bold; color: #555; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸš” è­¦å‹™å°ˆç”¨ï¼šåœ–ç‰‡è½‰æª”åŠ©æ‰‹ v3.0</h2>
    <span style="font-size: 0.8em; color: #95a5a6; display:block; margin-bottom: 20px;">é€šç”¨ç¸®æ”¾ç‰ˆï¼šåªè™•ç†ç•«è³ªèˆ‡æ ¼å¼ï¼Œå°ºå¯¸äº¤ç”± Excel æ±ºå®š</span>
    
    <div class="settings-area">
        <label>ğŸ–¨ï¸ è¼¸å‡ºç•«è³ª (DPI)ï¼š</label>
        <select id="dpiSelect">
            <option value="96">96 DPI (è¢å¹•ç”¨ï¼Œæª”æ¡ˆæœ€å°)</option>
            <option value="150">150 DPI (ä¸€èˆ¬æ–‡ä»¶ï¼Œå¹³è¡¡)</option>
            <option value="220" selected>220 DPI (æ¨™æº–åˆ—å°ï¼Œæ¨è–¦)</option>
            <option value="300">300 DPI (é«˜ç•«è³ªï¼Œæª”æ¡ˆè¼ƒå¤§)</option>
        </select>
    </div>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div style="font-size: 3em; color: #3498db; margin-bottom: 10px;">ğŸ“‚</div>
        <p>é»æ“Šé¸å– æˆ– æ‹–æ›³ç…§ç‰‡è‡³æ­¤<br><small>(æ”¯æ´ HEIC / PNG / WebP / JPG æ··é¸)</small></p>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*, .heic">
    
    <div class="file-list" id="fileList"></div>

    <button id="convertBtn" class="btn" style="display:none;">ğŸš€ é–‹å§‹è½‰æ›ä¸¦ä¸‹è¼‰ ZIP</button>

    <div class="progress-bar" id="progressArea"><div class="progress-fill" id="progressBar"></div></div>
    <p id="statusText"></p>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const progressArea = document.getElementById('progressArea');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const dpiSelect = document.getElementById('dpiSelect');
    const fileList = document.getElementById('fileList');
    let selectedFiles = [];

    // æ‹–æ›³æ”¯æ´
    const dropArea = document.querySelector('.upload-area');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, e => {e.preventDefault(); e.stopPropagation();}, false));
    dropArea.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); handleFiles(e.dataTransfer.files); }, false);
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/') || f.name.toLowerCase().endsWith('.heic'));
        if (newFiles.length === 0) { alert("ç„¡æ•ˆçš„åœ–ç‰‡ï¼"); return; }
        selectedFiles = newFiles;
        
        fileList.style.display = 'block';
        fileList.innerHTML = `<b>å·²å°±ç·’ ${selectedFiles.length} å€‹æª”æ¡ˆ</b><br>` + selectedFiles.map(f => `<small>â€¢ ${f.name}</small>`).join('<br>');
        convertBtn.style.display = 'block';
        progressArea.style.display = 'none';
        statusText.innerText = '';
    }

    convertBtn.addEventListener('click', async () => {
        const dpi = parseInt(dpiSelect.value);
        // è¨­å®šæœ€å¤§é•·é‚Šé™åˆ¶ï¼šä»¥ A4 å¯¬åº¦ç´„ 20cm ç‚ºåŸºæº–ï¼Œç¢ºä¿ä»»ä½•ç¸®æ”¾éƒ½ä¸æœƒæ¨¡ç³Š
        // 220 DPI æ™‚ç´„ç‚º 1732 px
        const maxLongSide = Math.round((20 / 2.54) * dpi);

        convertBtn.disabled = true;
        progressArea.style.display = 'block';
        
        const zip = new JSZip();
        const imgFolder = zip.folder("Processed_Images");
        const usedNames = new Set();

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            statusText.innerText = `è™•ç†ä¸­ (${i + 1}/${selectedFiles.length}): ${file.name}`;
            progressBar.style.width = `${(i / selectedFiles.length) * 90}%`;
            
            try {
                const blob = await processImage(file, maxLongSide);
                let name = file.name.replace(/\.[^/.]+$/, "") + ".jpg";
                let counter = 1;
                while (usedNames.has(name)) { name = name.replace(".jpg", `(${counter}).jpg`); counter++; }
                usedNames.add(name);
                imgFolder.file(name, blob);
            } catch (e) { console.error(e); }
        }

        statusText.innerText = "æ‰“åŒ…ä¸‹è¼‰ä¸­...";
        progressBar.style.width = "100%";
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, `è­¦å‹™ç…§ç‰‡_é€šç”¨_${dpi}DPI.zip`);
        
        statusText.innerText = "âœ… å®Œæˆï¼";
        convertBtn.disabled = false;
        convertBtn.innerText = "è™•ç†ä¸‹ä¸€æ‰¹";
        selectedFiles = []; // æ¸…ç©º
    });

    async function processImage(file, maxLongSide) {
        let srcBlob = file;
        // HEIC è§£ç¢¼
        if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
            const heicBlob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.9 });
            srcBlob = Array.isArray(heicBlob) ? heicBlob[0] : heicBlob;
        }
        
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                // é€šç”¨ç¸®æ”¾é‚è¼¯ï¼šé™åˆ¶ã€Œé•·é‚Šã€ä¸è¶…é maxLongSide
                let ratio = 1;
                if (img.width > img.height) {
                    if (img.width > maxLongSide) ratio = maxLongSide / img.width;
                } else {
                    if (img.height > maxLongSide) ratio = maxLongSide / img.height;
                }
                
                const w = Math.round(img.width * ratio);
                const h = Math.round(img.height * ratio);
                
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                
                // ç™½åº• (å»èƒŒ)
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, 0, 0, w, h);
                
                // è‹¥åŸåœ–å°±æ˜¯ JPG ä¸”å°ºå¯¸å·²ç¬¦åˆï¼Œé€™æ®µ Canvas é‡ç¹ªå…¶å¯¦å¯ä»¥å„ªåŒ–è·³é
                // ä½†ç‚ºäº†çµ±ä¸€å»èƒŒèˆ‡æ¸…é™¤ EXIFï¼Œå»ºè­°é‚„æ˜¯é‡ç¹ªä¸€æ¬¡
                canvas.toBlob(resolve, 'image/jpeg', 0.92);
            };
            img.onerror = () => reject(new Error("è¼‰å…¥å¤±æ•—"));
            img.src = URL.createObjectURL(srcBlob);
        });
    }
</script>
</body>
</html>