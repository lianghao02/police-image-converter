<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­¦å‹™å°ˆç”¨ï¼šå…¨èƒ½åœ–ç‰‡æ ¼å¼è½‰æ›å™¨ (æ™ºæ…§ç•¥é JPG)</title>
    
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding-top: 40px; color: #333; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); width: 650px; text-align: center; }
        h2 { color: #2c3e50; margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; }
        .badge { background-color: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; margin: 0 2px; }
        .desc { color: #7f8c8d; font-size: 0.95em; line-height: 1.6; margin-bottom: 25px; }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area {
            border: 3px dashed #bdc3c7;
            border-radius: 10px;
            padding: 50px;
            cursor: pointer;
            transition: 0.3s;
            background-color: #f9f9f9;
        }
        .upload-area:hover { background-color: #eaf2f8; border-color: #3498db; }
        .upload-area p { margin: 0; font-size: 1.2em; color: #7f8c8d; font-weight: bold; }
        .upload-icon { font-size: 3em; color: #3498db; margin-bottom: 10px; }
        
        #fileInput { display: none; }
        
        /* æ”¯æ´åˆ—è¡¨ */
        .support-list { font-size: 0.85em; color: #95a5a6; margin-top: 10px; }

        /* æŒ‰éˆ• */
        .btn {
            background-color: #27ae60; color: white; border: none;
            padding: 15px 40px; font-size: 1.1em; border-radius: 8px;
            cursor: pointer; margin-top: 25px; display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn:hover { background-color: #219150; transform: translateY(-2px); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }

        /* é€²åº¦æ¢ */
        .progress-container { margin-top: 25px; display: none; }
        .progress-bar { width: 100%; background-color: #ecf0f1; border-radius: 10px; overflow: hidden; height: 25px; }
        .progress-fill { height: 100%; width: 0%; background-color: #3498db; transition: width 0.3s; 
                         background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); 
                         background-size: 1rem 1rem; }
        .status-text { margin-top: 8px; font-size: 0.95em; color: #555; font-weight: bold; }

        .file-list { text-align: left; margin-top: 20px; max-height: 150px; overflow-y: auto; 
                     font-size: 0.9em; color: #555; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš” è­¦å‹™å°ˆç”¨ï¼šå…¨èƒ½åœ–ç‰‡è½‰æª”åŠ©æ‰‹</h2>
    <p class="desc">
        å°‡å„é¡è­‰æ“šæˆªåœ–ã€æ‰‹æ©Ÿç…§ç‰‡çµ±ä¸€è½‰æ›ç‚ºæ¨™æº– <b>JPG</b> æ ¼å¼ã€‚<br>
        <span style="color: #27ae60; font-weight: bold;">âš¡ æ™ºæ…§å„ªåŒ–ï¼šè‹¥åŸæª”å·²æ˜¯ JPGï¼Œå°‡ç›´æ¥æ‰“åŒ…ï¼Œä¿ç•™åŸå§‹ç•«è³ªã€‚</span><br>
        <span style="color: #e74c3c; font-weight: bold;">ğŸ”’ å®‰å…¨ä¿è­‰ï¼šæ‰€æœ‰é‹ç®—çš†åœ¨æœ¬æ©ŸåŸ·è¡Œï¼Œç„¡ç¶²è·¯å¤–æ´©é¢¨éšªã€‚</span>
    </p>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“‚</div>
        <p>é»æ“Šé¸å– æˆ– æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p>
        <div class="support-list">æ”¯æ´æ ¼å¼ï¼šHEIC, PNG, BMP, WebP, AVIF, GIF, JPG</div>
    </div>
    
    <input type="file" id="fileInput" multiple 
           accept="image/jpeg, image/png, image/webp, image/bmp, image/gif, image/avif, image/heic, image/heif, .heic, .heif">

    <div class="file-list" id="fileList"></div>

    <button id="convertBtn" class="btn">ğŸš€ é–‹å§‹è½‰æ›ä¸¦æ‰“åŒ…ä¸‹è¼‰</button>

    <div class="progress-container" id="progressArea">
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <p class="status-text" id="statusText">æº–å‚™ä¸­...</p>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const convertBtn = document.getElementById('convertBtn');
    const progressArea = document.getElementById('progressArea');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    let selectedFiles = [];

    // æ”¯æ´æ‹–æ›³æª”æ¡ˆ
    const dropArea = document.querySelector('.upload-area');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    
    dropArea.addEventListener('drop', handleDrop, false);
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files: files } });
    }

    // ç›£è½æª”æ¡ˆé¸å–
    fileInput.addEventListener('change', handleFiles);

    function handleFiles(e) {
        const newFiles = Array.from(e.target.files);
        const validFiles = newFiles.filter(f => f.type.startsWith('image/') || f.name.toLowerCase().endsWith('.heic'));
        
        if (validFiles.length === 0) {
            alert("è«‹é¸å–æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆï¼");
            return;
        }

        selectedFiles = validFiles;
        fileList.innerHTML = `<b>å·²å°±ç·’ ${selectedFiles.length} å€‹æª”æ¡ˆï¼š</b><br>` + 
                             selectedFiles.map(f => `â€¢ ${f.name} (${(f.size/1024).toFixed(1)} KB)`).join('<br>');
        convertBtn.style.display = 'inline-block';
        progressArea.style.display = 'none';
    }

    // é»æ“Šè½‰æ›
    convertBtn.addEventListener('click', async () => {
        if (selectedFiles.length === 0) return;

        convertBtn.disabled = true;
        progressArea.style.display = 'block';
        const zip = new JSZip();
        const imgFolder = zip.folder("Standardized_JPGs");

        let processedCount = 0;
        let failCount = 0;

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            
            // åˆ¤æ–·æ˜¯å¦ç‚º JPG (æ™ºæ…§åˆ¤æ–·)
            const isJpg = file.type === 'image/jpeg' || file.name.toLowerCase().endsWith('.jpg') || file.name.toLowerCase().endsWith('.jpeg');
            const actionText = isJpg ? "ç›´æ¥æ‰“åŒ…" : "è½‰æ›ä¸­";
            
            statusText.innerText = `[${actionText}] (${i + 1}/${selectedFiles.length}): ${file.name}...`;
            updateProgress((i / selectedFiles.length) * 90);

            try {
                const jpgBlob = await convertToJpg(file);
                // çµ±ä¸€å‰¯æª”åç‚º .jpg (è‹¥åŸæª”æ˜¯ .jpeg ä¹Ÿæœƒçµ±ä¸€)
                const newName = file.name.substring(0, file.name.lastIndexOf('.')) + ".jpg";
                imgFolder.file(newName, jpgBlob);
            } catch (err) {
                console.error("è½‰æ›å¤±æ•—:", file.name, err);
                failCount++;
            }
            processedCount++;
        }

        statusText.innerText = "æ­£åœ¨å£“ç¸®æ‰“åŒ…...";
        updateProgress(95);
        
        zip.generateAsync({ type: "blob" }).then(function (content) {
            const timestamp = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 12);
            saveAs(content, `è­¦å‹™è½‰æª”å®Œæˆ_${timestamp}.zip`);
            updateProgress(100);
            
            let finalMsg = `âœ… å®Œæˆï¼è™•ç†äº† ${processedCount - failCount} å¼µåœ–ç‰‡ã€‚`;
            if (failCount > 0) finalMsg += ` (æœ‰ ${failCount} å¼µå¤±æ•—)`;
            statusText.innerText = finalMsg;
            
            convertBtn.disabled = false;
            convertBtn.innerText = "ä¸‹è¼‰å®Œæˆï¼Œå¯å†æ¬¡è™•ç†";
        });
    });

    function updateProgress(percent) {
        progressBar.style.width = percent + "%";
    }

    // æ ¸å¿ƒè½‰æ›é‚è¼¯
    async function convertToJpg(file) {
        
        // === æ™ºæ…§åˆ¤æ–·ï¼šå¦‚æœæ˜¯ JPGï¼Œç›´æ¥å›å‚³åŸæª” (ä¸é‡æ–°å£“ç¸®) ===
        if (file.type === 'image/jpeg' || file.name.toLowerCase().endsWith('.jpg') || file.name.toLowerCase().endsWith('.jpeg')) {
            return file; // ç›´æ¥å›å‚³ File ç‰©ä»¶ (File ç¹¼æ‰¿è‡ª Blobï¼ŒJSZip å¯ç›´æ¥ç”¨)
        }
        // =====================================================

        // 1. ç‰¹æ®Šè™•ç† iPhone HEIC
        if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
            try {
                const blob = await heic2any({
                    blob: file,
                    toType: "image/jpeg",
                    quality: 0.92
                });
                return Array.isArray(blob) ? blob[0] : blob;
            } catch (e) {
                throw new Error("HEIC è§£ç¢¼å¤±æ•—");
            }
        }
        
        // 2. é€šç”¨è™•ç† (PNG, BMP, WebP, GIF, AVIF) -> è½‰ JPG
        return new Promise((resolve, reject) => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                
                // ç¹ªè£½ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob((blob) => {
                    URL.revokeObjectURL(url);
                    if (blob) resolve(blob);
                    else reject(new Error("Canvas è¼¸å‡ºå¤±æ•—"));
                }, 'image/jpeg', 0.92);
            };
            
            img.onerror = () => {
                URL.revokeObjectURL(url);
                reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—"));
            };
            
            img.src = url;
        });
    }
</script>

</body>
</html>