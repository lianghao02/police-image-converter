<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­¦å‹™å°ˆç”¨ï¼šåœ–ç‰‡è½‰æª”åŠ©æ‰‹ v3.1</title>
    
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #e67e22;
            --danger-color: #c0392b;
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            padding-top: 40px;
            color: #333;
            margin: 0;
        }

        .container {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 700px;
            text-align: center;
            transition: transform 0.2s;
        }

        h2 { color: var(--primary-color); margin: 0 0 10px 0; font-size: 28px; font-weight: 700; }
        .badge { background: var(--accent-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; vertical-align: middle; margin-left: 10px; }
        .desc { color: #7f8c8d; font-size: 0.95em; margin-bottom: 30px; line-height: 1.5; }

        /* è¨­å®šå€å¡Š */
        .settings-panel {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .settings-panel label { font-weight: bold; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
        .settings-panel select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            width: 60%;
        }

        /* ä¸Šå‚³å€å¡Š */
        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            cursor: pointer;
            background-color: #ffffff;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .upload-area:hover { border-color: var(--accent-color); background-color: #ebf8ff; transform: translateY(-2px); }
        .upload-area.active { border-color: var(--success-color); background-color: #f0fff4; }
        
        .upload-icon { font-size: 48px; color: var(--accent-color); margin-bottom: 10px; }
        .upload-text { font-size: 18px; color: #4a5568; font-weight: 500; }
        .upload-subtext { font-size: 13px; color: #a0aec0; margin-top: 5px; }

        #fileInput { display: none; }

        /* æª”æ¡ˆåˆ—è¡¨ */
        .file-list-container {
            margin-top: 20px;
            text-align: left;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        .file-item { font-size: 13px; padding: 5px 0; border-bottom: 1px solid #f0f0f0; color: #555; display: flex; justify-content: space-between; }
        .file-item:last-child { border-bottom: none; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0.6; /* é è¨­ç¦ç”¨ç‹€æ…‹ */
            pointer-events: none;
        }

        .btn.active { opacity: 1; pointer-events: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(1px); box-shadow: none; }

        .btn-primary { background-color: var(--success-color); color: white; }
        .btn-primary:hover { background-color: #219150; }

        .btn-warning { background-color: var(--warning-color); color: white; display: none; } /* é è¨­éš±è— */
        .btn-warning:hover { background-color: #d35400; }

        .btn-danger { background-color: var(--danger-color); color: white; flex: 0.5; }
        .btn-danger:hover { background-color: #a93226; }

        /* é€²åº¦æ¢ */
        .progress-container { margin-top: 25px; display: none; }
        .progress-bar-bg { width: 100%; background-color: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.3s ease; border-radius: 5px; }
        .status-text { margin-top: 10px; font-size: 14px; color: #4a5568; font-weight: 600; }

    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš” è­¦å‹™å°ˆç”¨åœ–ç‰‡è½‰æª”åŠ©æ‰‹ <span class="badge">v3.1</span></h2>
    <p class="desc">å…¨æœ¬æ©Ÿé›¢ç·šé‹ç®—ï¼Œæ”¯æ´ HEIC/PNG/WebP è½‰ JPGã€‚<br>è‡ªå‹•å„ªåŒ–ç•«è³ªèˆ‡å°ºå¯¸ï¼Œå°ˆç‚º Excel è‡ªå‹•åŒ–ç³»çµ±è¨­è¨ˆã€‚</p>

    <div class="settings-panel">
        <label>ğŸ–¨ï¸ è¼¸å‡ºç•«è³ª (DPI)</label>
        <select id="dpiSelect">
            <option value="96">96 DPI (è¢å¹•ç”¨ - æª”æ¡ˆæœ€å°)</option>
            <option value="150">150 DPI (ä¸€èˆ¬æ–‡ä»¶ - å¹³è¡¡)</option>
            <option value="220" selected>220 DPI (æ¨™æº–åˆ—å° - æ¨è–¦)</option>
            <option value="300">300 DPI (é«˜ç•«è³ª - æª”æ¡ˆè¼ƒå¤§)</option>
        </select>
    </div>

    <div class="upload-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“‚</div>
        <div class="upload-text">é»æ“Šé¸å– æˆ– æ‹–æ›³ç…§ç‰‡è‡³æ­¤</div>
        <div class="upload-subtext">æ”¯æ´ JPG, HEIC, PNG, BMP, WebP (å¯å¤šé¸)</div>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*, .heic">

    <div class="file-list-container" id="fileList"></div>

    <div class="btn-group">
        <button id="btnConvert" class="btn btn-primary">
            <span>ğŸš€ é–‹å§‹è½‰æ›</span>
        </button>
        <button id="btnReconvert" class="btn btn-warning">
            <span>ğŸ”„ é‡æ–°è½‰æ›</span>
        </button>
        <button id="btnClear" class="btn btn-danger">
            <span>ğŸ—‘ï¸ æ¸…é™¤é‡ç½®</span>
        </button>
    </div>

    <div class="progress-container" id="progressArea">
        <div class="progress-bar-bg"><div class="progress-fill" id="progressBar"></div></div>
        <p class="status-text" id="statusText">æº–å‚™å°±ç·’</p>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileListContainer = document.getElementById('fileList');
    const dropArea = document.getElementById('dropArea');
    
    const btnConvert = document.getElementById('btnConvert');
    const btnReconvert = document.getElementById('btnReconvert');
    const btnClear = document.getElementById('btnClear');
    
    const progressArea = document.getElementById('progressArea');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const dpiSelect = document.getElementById('dpiSelect');
    
    let selectedFiles = [];

    // --- äº‹ä»¶ç›£è½ ---

    // æ‹–æ›³æ•ˆæœ
    ['dragenter', 'dragover'].forEach(e => {
        dropArea.addEventListener(e, (ev) => {
            ev.preventDefault(); dropArea.classList.add('active');
        });
    });
    ['dragleave', 'drop'].forEach(e => {
        dropArea.addEventListener(e, (ev) => {
            ev.preventDefault(); dropArea.classList.remove('active');
        });
    });
    dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    // æŒ‰éˆ•äº‹ä»¶
    btnConvert.addEventListener('click', () => startProcess());
    
    // é‡æ–°è½‰æ›ï¼šå…¶å¯¦å°±æ˜¯é‡è·‘ä¸€æ¬¡ startProcessï¼Œä½†é€šå¸¸ç”¨æ–¼ä½¿ç”¨è€…æ”¹äº† DPI å¾Œæƒ³é‡è·‘
    btnReconvert.addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦ä½¿ç”¨æ–°çš„è¨­å®šé‡æ–°è½‰æ›ä¸€æ¬¡å—ï¼Ÿ")) {
            startProcess();
        }
    });

    // æ¸…é™¤é‡ç½®
    btnClear.addEventListener('click', () => {
        selectedFiles = [];
        fileInput.value = '';
        fileListContainer.style.display = 'none';
        fileListContainer.innerHTML = '';
        progressArea.style.display = 'none';
        statusText.innerText = '';
        progressBar.style.width = '0%';
        
        // æŒ‰éˆ•ç‹€æ…‹é‚„åŸ
        btnConvert.classList.remove('active');
        btnClear.classList.remove('active');
        btnReconvert.style.display = 'none';
        btnConvert.style.display = 'flex';
        btnConvert.innerText = "ğŸš€ é–‹å§‹è½‰æ›";
    });

    // --- æ ¸å¿ƒé‚è¼¯ ---

    function handleFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/') || f.name.toLowerCase().endsWith('.heic'));
        if (newFiles.length === 0) { alert("è«‹é¸å–æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆï¼"); return; }
        
        selectedFiles = newFiles;
        
        // æ›´æ–°æ¸…å–®ä»‹é¢
        fileListContainer.style.display = 'block';
        fileListContainer.innerHTML = selectedFiles.map(f => 
            `<div class="file-item"><span>${f.name}</span><span>${(f.size/1024).toFixed(1)} KB</span></div>`
        ).join('');
        
        // å•Ÿç”¨æŒ‰éˆ•
        btnConvert.classList.add('active');
        btnClear.classList.add('active');
        btnReconvert.style.display = 'none'; // éš±è—é‡æ–°è½‰æ›
        btnConvert.style.display = 'flex';     // é¡¯ç¤ºé–‹å§‹è½‰æ›
        progressArea.style.display = 'none';
    }

    async function startProcess() {
        if (selectedFiles.length === 0) return;
        
        const dpi = parseInt(dpiSelect.value);
        const maxLongSide = Math.round((20 / 2.54) * dpi); // 20cm ç‚ºåŸºæº–

        // é–å®šä»‹é¢
        btnConvert.classList.remove('active');
        btnReconvert.classList.remove('active');
        btnClear.classList.remove('active');
        progressArea.style.display = 'block';
        
        const zip = new JSZip();
        const imgFolder = zip.folder("Processed_Images");
        const usedNames = new Set();

        let processedCount = 0;
        let failCount = 0;

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            statusText.innerText = `æ­£åœ¨è™•ç† (${i + 1}/${selectedFiles.length})ï¼š${file.name}`;
            progressBar.style.width = `${((i) / selectedFiles.length) * 90}%`;
            
            try {
                const blob = await processImage(file, maxLongSide);
                let name = file.name.replace(/\.[^/.]+$/, "") + ".jpg";
                
                // é˜²é‡å
                let counter = 1;
                let baseName = name;
                while (usedNames.has(name)) { 
                    name = baseName.replace(".jpg", `(${counter}).jpg`); 
                    counter++; 
                }
                usedNames.add(name);
                
                imgFolder.file(name, blob);
            } catch (e) { 
                console.error(e); failCount++; 
            }
            processedCount++;
        }

        statusText.innerText = "æ­£åœ¨å£“ç¸®æ‰“åŒ… ZIP...";
        progressBar.style.width = "100%";
        
        const content = await zip.generateAsync({ type: "blob" });
        const timestamp = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 12);
        saveAs(content, `è­¦å‹™ç…§ç‰‡_${dpi}DPI_${timestamp}.zip`);
        
        // å®Œæˆç‹€æ…‹
        statusText.innerText = `âœ… å®Œæˆï¼æˆåŠŸ ${processedCount - failCount} å¼µ` + (failCount > 0 ? ` (å¤±æ•— ${failCount})` : "");
        
        // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
        btnConvert.style.display = 'none';    // éš±è—é–‹å§‹æŒ‰éˆ•
        btnReconvert.style.display = 'flex';  // é¡¯ç¤ºé‡æ–°è½‰æ›
        
        btnReconvert.classList.add('active');
        btnClear.classList.add('active');
    }

    async function processImage(file, maxLongSide) {
        // 1. æ™ºæ…§ç•¥é JPG (å¦‚æœä¸éœ€èª¿æ•´å¤§å°ï¼Œå¯ç›´æ¥å›å‚³åŸæª”ï¼Œä½†ç‚ºäº†çµ±ä¸€ DPIï¼Œé€™è£¡å»ºè­°é‚„æ˜¯é‡ç¹ª)
        // å¦‚æœæ‚¨å¸Œæœ› JPG åŸåœ–ç›´å‡ºï¼Œè«‹å–æ¶ˆä¸‹é¢è¨»è§£ï¼š
        /*
        if (file.type === 'image/jpeg' || file.name.toLowerCase().endsWith('.jpg')) {
             return file;
        }
        */

        let srcBlob = file;
        // HEIC è§£ç¢¼
        if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
            const heicBlob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.92 });
            srcBlob = Array.isArray(heicBlob) ? heicBlob[0] : heicBlob;
        }
        
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                let ratio = 1;
                if (Math.max(img.width, img.height) > maxLongSide) {
                    ratio = maxLongSide / Math.max(img.width, img.height);
                }
                
                const w = Math.round(img.width * ratio);
                const h = Math.round(img.height * ratio);
                
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                
                // ç™½åº•å»èƒŒ
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, 0, 0, w, h);
                
                canvas.toBlob(resolve, 'image/jpeg', 0.92);
            };
            img.onerror = () => reject(new Error("Load failed"));
            img.src = URL.createObjectURL(srcBlob);
        });
    }
</script>
</body>
</html>