<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­¦å‹™å°ˆç”¨ï¼šåœ–ç‰‡è½‰æª”èˆ‡ç¸®æ”¾åŠ©æ‰‹ v2.0</title>
    
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding-top: 30px; color: #333; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); width: 700px; text-align: center; }
        h2 { color: #2c3e50; margin-bottom: 5px; font-weight: bold; }
        .version { font-size: 0.8em; color: #95a5a6; margin-bottom: 15px; display: block; }
        .desc { color: #7f8c8d; font-size: 0.95em; line-height: 1.6; margin-bottom: 20px; }
        
        /* ä¸Šå‚³å€ */
        .upload-area {
            border: 3px dashed #bdc3c7; border-radius: 10px; padding: 30px;
            cursor: pointer; transition: 0.3s; background-color: #f9f9f9;
        }
        .upload-area:hover { background-color: #eaf2f8; border-color: #3498db; }
        .upload-icon { font-size: 2.5em; color: #3498db; margin-bottom: 5px; }
        #fileInput { display: none; }
        .support-list { font-size: 0.85em; color: #95a5a6; margin-top: 10px; }

        /* æª”æ¡ˆåˆ—è¡¨ */
        .file-list { text-align: left; margin-top: 15px; max-height: 120px; overflow-y: auto; 
                     font-size: 0.9em; color: #555; border: 1px solid #eee; padding: 10px; border-radius: 5px; display: none;}

        /* æŒ‰éˆ•ç¾¤çµ„ (é›™æ’è¨­è¨ˆ) */
        .action-area { margin-top: 25px; display: none; flex-direction: column; gap: 15px; }
        .mode-group { display: flex; gap: 15px; justify-content: center; }
        
        .btn {
            color: white; border: none; padding: 15px 20px; font-size: 1em; 
            border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            transition: 0.2s; flex: 1; display: flex; flex-direction: column; align-items: center;
        }
        .btn span { font-size: 0.8em; opacity: 0.9; margin-top: 5px; font-weight: normal; }
        .btn-landscape { background-color: #2980b9; }
        .btn-landscape:hover { background-color: #21618c; transform: translateY(-2px); }
        
        .btn-portrait { background-color: #e67e22; }
        .btn-portrait:hover { background-color: #ca6f1e; transform: translateY(-2px); }

        .btn-reset { background-color: #95a5a6; width: 100%; margin-top: 5px; padding: 10px; }
        .btn-reset:hover { background-color: #7f8c8d; }
        
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }

        /* é€²åº¦æ¢ */
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; background-color: #ecf0f1; border-radius: 10px; overflow: hidden; height: 20px; }
        .progress-fill { height: 100%; width: 0%; background-color: #27ae60; transition: width 0.3s; }
        .status-text { margin-top: 8px; font-size: 0.9em; color: #555; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš” è­¦å‹™å°ˆç”¨ï¼šåœ–ç‰‡è½‰æª”èˆ‡ç¸®æ”¾åŠ©æ‰‹</h2>
    <span class="version">v2.0 | å«å°ºå¯¸è‡ªå‹•ç¸®æ”¾ (220 DPI)</span>
    <p class="desc">
        è‡ªå‹•å°‡ HEIC/PNG/WebP ç­‰æ ¼å¼è½‰ç‚º JPGï¼Œä¸¦åŒæ™‚èª¿æ•´åƒç´ å¤§å°ã€‚<br>
        <span style="color: #e74c3c; font-weight: bold;">ğŸ”’ è³‡å®‰ä¿è­‰ï¼šå…¨æœ¬æ©Ÿé›¢ç·šé‹ç®—ï¼Œç„¡è³‡æ–™å¤–æ´©é¢¨éšªã€‚</span>
    </p>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“‚</div>
        <p>é»æ“Šé¸å– æˆ– æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p>
        <div class="support-list">æ”¯æ´æ ¼å¼ï¼šHEIC, PNG, BMP, WebP, JPG...</div>
    </div>
    
    <input type="file" id="fileInput" multiple accept="image/*, .heic">

    <div class="file-list" id="fileList"></div>

    <div class="action-area" id="actionArea">
        <div class="mode-group">
            <button id="btnLandscape" class="btn btn-landscape">
                ğŸ“ è™•ç†ï¼šä¸€èˆ¬ç…§ç‰‡
                <span>ç›®æ¨™ï¼š13.5 x 8 cm (æ©«å¼)</span>
            </button>
            <button id="btnPortrait" class="btn btn-portrait">
                ğŸ“± è™•ç†ï¼šæ‰‹æ©Ÿæˆªåœ–
                <span>ç›®æ¨™ï¼š8 x 17 cm (ç›´å¼)</span>
            </button>
        </div>
        <button id="btnReset" class="btn btn-reset">ğŸ”„ æ¸…ç©ºé‡ç½®</button>
    </div>

    <div class="progress-container" id="progressArea">
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <p class="status-text" id="statusText">æº–å‚™ä¸­...</p>
    </div>
</div>

<script>
    // === è¨­å®šå€ (220 DPI) ===
    const DPI = 220;
    // ä¸€èˆ¬ç…§ç‰‡ (13.5 x 8 cm)
    const LANDSCAPE_W = Math.round((13.5 / 2.54) * DPI); // ~1169 px
    const LANDSCAPE_H = Math.round((8 / 2.54) * DPI);    // ~693 px
    // æ‰‹æ©Ÿæˆªåœ– (8 x 17 cm)
    const PORTRAIT_W = Math.round((8 / 2.54) * DPI);     // ~693 px
    const PORTRAIT_H = Math.round((17 / 2.54) * DPI);    // ~1472 px

    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const actionArea = document.getElementById('actionArea');
    const btnLandscape = document.getElementById('btnLandscape');
    const btnPortrait = document.getElementById('btnPortrait');
    const btnReset = document.getElementById('btnReset');
    const progressArea = document.getElementById('progressArea');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    let selectedFiles = [];

    // æ‹–æ›³æ”¯æ´
    const dropArea = document.querySelector('.upload-area');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, preventDefaults, false));
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    dropArea.addEventListener('drop', handleDrop, false);
    function handleDrop(e) { handleFiles({ target: { files: e.dataTransfer.files } }); }

    // é¸å–æª”æ¡ˆ
    fileInput.addEventListener('change', handleFiles);

    function handleFiles(e) {
        const newFiles = Array.from(e.target.files);
        const validFiles = newFiles.filter(f => f.type.startsWith('image/') || f.name.toLowerCase().endsWith('.heic'));
        
        if (validFiles.length === 0) { alert("è«‹é¸å–æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆï¼"); return; }

        selectedFiles = validFiles;
        fileList.style.display = 'block';
        fileList.innerHTML = `<b>å·²å°±ç·’ ${selectedFiles.length} å€‹æª”æ¡ˆï¼š</b><br>` + 
                             selectedFiles.map(f => `â€¢ ${f.name} (${(f.size/1024).toFixed(1)} KB)`).join('<br>');
        actionArea.style.display = 'flex';
        progressArea.style.display = 'none';
        enableButtons(true);
    }

    // é‡ç½®
    btnReset.addEventListener('click', () => {
        selectedFiles = [];
        fileInput.value = '';
        fileList.style.display = 'none';
        fileList.innerHTML = '';
        actionArea.style.display = 'none';
        progressArea.style.display = 'none';
        statusText.innerText = '';
        progressBar.style.width = '0%';
    });

    // æŒ‰éˆ•äº‹ä»¶ç¶å®š
    btnLandscape.addEventListener('click', () => startProcess(LANDSCAPE_W, LANDSCAPE_H, "ä¸€èˆ¬ç…§ç‰‡"));
    btnPortrait.addEventListener('click', () => startProcess(PORTRAIT_W, PORTRAIT_H, "æ‰‹æ©Ÿæˆªåœ–"));

    function enableButtons(enabled) {
        btnLandscape.disabled = !enabled;
        btnPortrait.disabled = !enabled;
        btnReset.disabled = !enabled;
    }

    // ä¸»è™•ç†æµç¨‹
    async function startProcess(maxW, maxH, modeName) {
        if (selectedFiles.length === 0) return;

        enableButtons(false);
        progressArea.style.display = 'block';
        const zip = new JSZip();
        const imgFolder = zip.folder(modeName + "_Processed");
        const usedNames = new Set();

        let processedCount = 0;
        let failCount = 0;

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            statusText.innerText = `æ­£åœ¨è™•ç† (${i + 1}/${selectedFiles.length}): ${file.name}...`;
            updateProgress((i / selectedFiles.length) * 90);

            try {
                // 1. çµ±ä¸€è½‰æˆ JPG Blob (å¦‚æœæ˜¯ HEIC æœƒå…ˆè§£ç¢¼)
                const sourceBlob = await getJpgBlob(file);
                
                // 2. èª¿æ•´å°ºå¯¸ (Resize)
                const resizedBlob = await resizeImage(sourceBlob, maxW, maxH);

                // 3. æª”åé˜²é‡è¤‡
                let baseName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                let newName = baseName + ".jpg";
                let counter = 1;
                while (usedNames.has(newName)) {
                    newName = `${baseName}(${counter}).jpg`;
                    counter++;
                }
                usedNames.add(newName);

                imgFolder.file(newName, resizedBlob);

            } catch (err) {
                console.error("å¤±æ•—:", file.name, err);
                failCount++;
            }
            processedCount++;
        }

        statusText.innerText = "æ­£åœ¨æ‰“åŒ…ä¸‹è¼‰...";
        updateProgress(95);
        
        zip.generateAsync({ type: "blob" }).then(function (content) {
            const timestamp = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 12);
            saveAs(content, `è­¦å‹™ç…§ç‰‡_${modeName}_${timestamp}.zip`);
            updateProgress(100);
            
            let finalMsg = `âœ… å®Œæˆï¼æˆåŠŸ ${processedCount - failCount} å¼µ`;
            if (failCount > 0) finalMsg += `ï¼Œå¤±æ•— ${failCount} å¼µ`;
            statusText.innerText = finalMsg;
            
            enableButtons(true);
        });
    }

    function updateProgress(percent) { progressBar.style.width = percent + "%"; }

    // éšæ®µä¸€ï¼šå–å¾—åŸå§‹åœ–ç‰‡çš„ JPG Blob (è™•ç†æ ¼å¼å•é¡Œ)
    async function getJpgBlob(file) {
        // å¦‚æœæ˜¯ HEIC
        if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
            try {
                const blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.95 });
                return Array.isArray(blob) ? blob[0] : blob;
            } catch (e) { throw new Error("HEIC è§£ç¢¼å¤±æ•—"); }
        }
        return file; // å…¶ä»–æ ¼å¼ç›´æ¥å›å‚³ï¼Œå¾… Canvas è™•ç†
    }

    // éšæ®µäºŒï¼šé€é Canvas èª¿æ•´å°ºå¯¸ (Resize & Pixel Resampling)
    function resizeImage(fileBlob, targetMaxW, targetMaxH) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            const url = URL.createObjectURL(fileBlob);

            img.onload = () => {
                // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ (Best Fit / Contain)
                // é‚è¼¯ï¼šæ‰¾å‡ºèƒ½è®“åœ–ç‰‡å®Œå…¨å¡å…¥ç›®æ¨™æ¡†æ¡†çš„æœ€å¤§æ¯”ä¾‹
                let ratio = Math.min(targetMaxW / img.width, targetMaxH / img.height);
                
                // å¦‚æœåœ–ç‰‡æœ¬ä¾†å°±æ¯”ç›®æ¨™å°ï¼Œæ˜¯å¦è¦æ”¾å¤§ï¼Ÿ 
                // å»ºè­°ï¼šä¿æŒåŸå¤§å°æˆ–æ”¾å¤§çš†å¯ã€‚é€™è£¡æ¡ç”¨ã€Œä¸æ”¾å¤§è¶…éåŸåœ–å¤ªèª‡å¼µï¼Œä½†è‹¥å¤§æ–¼ç›®æ¨™å‰‡ç¸®å°ã€
                // ç‚ºäº†çµ±ä¸€æ ¼å¼ï¼Œæˆ‘å€‘å¼·åˆ¶ç¸®æ”¾åˆ°ç›®æ¨™æ¡†æ¡†å…§ (è‹¥åŸåœ–å¾ˆå°å‰‡ä¸æ”¾å¤§)
                if (ratio > 1) ratio = 1; 

                const newW = Math.round(img.width * ratio);
                const newH = Math.round(img.height * ratio);

                const canvas = document.createElement('canvas');
                canvas.width = newW;
                canvas.height = newH;
                const ctx = canvas.getContext('2d');

                // ç™½åº• (è™•ç†é€æ˜åœ–)
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, newW, newH);
                
                // ç¹ªè£½ä¸¦ç¸®æ”¾ (é«˜å“è³ª)
                ctx.drawImage(img, 0, 0, newW, newH);

                canvas.toBlob((blob) => {
                    URL.revokeObjectURL(url);
                    if (blob) resolve(blob);
                    else reject(new Error("Canvas è¼¸å‡ºéŒ¯èª¤"));
                }, 'image/jpeg', 0.92); // 92% å“è³ª JPG
            };

            img.onerror = () => {
                URL.revokeObjectURL(url);
                reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—"));
            };

            img.src = url;
        });
    }
</script>
</body>
</html>